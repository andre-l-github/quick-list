var page = angular.module('project', ['ngRoute', 'ngResource']);

page.factory("NotificationsService", function() {
  var source = new EventSource('/api/notifications/lists');

  return {
    addListener: function(event, fn) {
      source.addEventListener(event, function(e) {
        fn($.parseJSON(e.data));
      });
    }
  };
});

var Repository = function($service, $notifications) {
  this.notifications = $notifications;
  this.service       = $service;

  this.query = function(fn) {
    this.service.query(fn);
  };

  this.get = function(id) {
    return this.service.get({ id: id });
  };

  this.create = function(attr) {
    return this.service.save({ list: attr });
  }
};

page.factory('ListsRepository', function ($resource, NotificationsService) {
  var service    = $resource('/api/lists/:id', { id: '@id' });
  var repository = new Repository(service, NotificationsService);
  var listeners = [];

  NotificationsService.addListener("created", function(newList) {
    $.each(listeners, function(idx, listener) {
      listener();
    });
  });

  return $.extend(repository, {
    addListener: function(fn) {
      listeners.push(fn);
    }
  });
});

page.controller('IndexCtrl', function($scope, ListsRepository) {
  ListsRepository.query(function(data) {
    $scope.lists = data;
  });
  ListsRepository.addListener(function() {
    ListsRepository.query(function(data) {
      $scope.lists = data;
    });
  });
  $scope.create = function() {
    ListsRepository.create({ name: $scope.list.name });
    $scope.list.name = "";
  }
});

page.controller('EditCtrl', function($scope, $routeParams, ListsRepository) {
  $scope.list = ListsRepository.get($routeParams.id);
});

page.config(function($routeProvider) {
  $routeProvider
    .when('/', {
      controller:'IndexCtrl',
      templateUrl: '<%= asset_path("landing/index.html") %>'
    })
    .when('/lists/:id', {
      controller:'EditCtrl',
      templateUrl: '<%= asset_path("landing/edit.html") %>'
    })
    .otherwise({
      redirectTo:'/'
    });
});
